    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
        <title>KK Book Diary - Admin</title>
        <style>
            /* Mobile-First Design with Fixed UI Issues */
            :root {
                --primary: #000000;
                --secondary: #333333;
                --light: #f8f9fa;
                --border: #e0e0e0;
                --danger: #dc3545;
                --success: #28a745;
                --warning: #ffc107;
                --radius: 12px;
                --shadow: 0 2px 10px rgba(0,0,0,0.1);
                --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                --safe-area-inset-top: env(safe-area-inset-top, 0px);
                --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            html {
                height: 100%;
                -webkit-text-size-adjust: 100%;
            }

            body {
                font-family: var(--font-family);
                background: var(--light);
                color: var(--primary);
                line-height: 1.6;
                font-size: 16px;
                min-height: 100vh;
                padding-top: calc(81px + 56px + var(--safe-area-inset-top));
                padding-bottom: calc(80px + var(--safe-area-inset-bottom));
                -webkit-tap-highlight-color: transparent;
                -webkit-font-smoothing: antialiased;
            }

            /* Fixed Header */
            .header {
                background: white;
                padding: 16px;
                padding-top: calc(16px + var(--safe-area-inset-top));
                border-bottom: 1px solid var(--border);
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                height: 81px;
            }

            .header h1 {
                font-size: 22px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .header h1 svg {
                width: 28px;
                height: 28px;
                flex-shrink: 0;
            }

            /* Fixed Tabs */
            .tabs {
                display: flex;
                background: white;
                border-bottom: 1px solid var(--border);
                position: fixed;
                top: 81px;
                left: 0;
                right: 0;
                z-index: 999;
                height: 56px;
            }

            .tab {
                flex: 1;
                padding: 18px 12px;
                text-align: center;
                background: none;
                border: none;
                font-size: 16px;
                font-weight: 500;
                color: #666;
                cursor: pointer;
                border-bottom: 3px solid transparent;
                transition: all 0.3s;
                min-height: 56px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                -webkit-tap-highlight-color: transparent;
            }

            .tab.active {
                color: var(--primary);
                border-bottom-color: var(--primary);
                background: rgba(0,0,0,0.02);
            }

            /* Content */
            .content {
                padding: 16px;
                padding-top: 20px;
            }

            .section {
                display: none;
                animation: fadeIn 0.3s ease;
            }

            .section.active {
                display: block;
            }

            /* Form */
            .form-card {
                background: white;
                border-radius: var(--radius);
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: var(--shadow);
            }

            .form-group {
                margin-bottom: 20px;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                color: var(--secondary);
                font-size: 15px;
            }

            .required::after {
                content: " *";
                color: var(--danger);
            }

            input, textarea, select {
                width: 100%;
                padding: 16px;
                border: 1px solid var(--border);
                border-radius: 8px;
                font-size: 16px;
                font-family: inherit;
                background: white;
                transition: border 0.3s;
                -webkit-appearance: none;
                appearance: none;
            }

            input:focus, textarea:focus, select:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
            }

            textarea {
                min-height: 120px;
                resize: vertical;
                line-height: 1.5;
            }

            input[type="date"] {
                min-height: 54px;
            }

            /* Photo Upload - Improved for Mobile */
            .photo-upload {
                border: 2px dashed var(--border);
                border-radius: 8px;
                padding: 30px 20px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s;
                touch-action: manipulation;
            }

            .photo-upload:hover, .photo-upload:active {
                border-color: var(--primary);
                background: rgba(0,0,0,0.02);
            }

            .photo-upload svg {
                width: 48px;
                height: 48px;
                margin-bottom: 12px;
                color: #999;
            }

            .photo-preview {
                margin-top: 15px;
                text-align: center;
            }

            .photo-preview img {
                max-width: 150px;
                max-height: 150px;
                border-radius: 8px;
                object-fit: cover;
                border: 3px solid white;
                box-shadow: var(--shadow);
            }

            /* Buttons - Improved Touch Targets */
            .buttons {
                display: flex;
                gap: 12px;
                margin-top: 24px;
            }

            .btn {
                flex: 1;
                padding: 18px 16px;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.3s;
                min-height: 56px;
                touch-action: manipulation;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .btn svg {
                width: 20px;
                height: 20px;
                flex-shrink: 0;
            }

            .btn-primary {
                background: var(--primary);
                color: white;
            }

            .btn-primary:hover, .btn-primary:active {
                background: #222;
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-secondary:hover, .btn-secondary:active {
                background: #5a6268;
            }

            .btn-success {
                background: var(--success);
                color: white;
            }

            .btn-warning {
                background: var(--warning);
                color: #212529;
            }

            .btn-danger {
                background: var(--danger);
                color: white;
            }

            /* Profiles List */
            .profiles-grid {
                display: grid;
                gap: 16px;
                margin-top: 16px;
            }

            .profile-card {
                background: white;
                border-radius: var(--radius);
                padding: 16px;
                box-shadow: var(--shadow);
                transition: transform 0.3s, box-shadow 0.3s;
                touch-action: manipulation;
            }

            .profile-card:active {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }

            .profile-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 12px;
            }

            .profile-avatar {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                object-fit: cover;
                border: 3px solid var(--border);
                flex-shrink: 0;
            }

            .profile-info {
                flex: 1;
                min-width: 0; /* Prevents overflow */
            }

            .profile-name {
                font-weight: 600;
                font-size: 18px;
                margin-bottom: 4px;
                color: var(--primary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .profile-date {
                font-size: 14px;
                color: #666;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .profile-date svg {
                flex-shrink: 0;
            }

            .profile-note {
                font-size: 15px;
                color: var(--secondary);
                margin-bottom: 16px;
                line-height: 1.5;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                word-break: break-word;
            }

            .profile-actions {
                display: flex;
                gap: 8px;
                border-top: 1px solid var(--border);
                padding-top: 12px;
                flex-wrap: wrap;
            }

            .action-btn {
                flex: 1;
                padding: 12px 8px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                transition: all 0.3s;
                min-height: 44px;
                min-width: 70px;
                touch-action: manipulation;
            }

            .action-btn svg {
                width: 16px;
                height: 16px;
                flex-shrink: 0;
            }

            .btn-view { background: #e3f2fd; color: #1976d2; }
            .btn-edit { background: #e8f5e9; color: #2e7d32; }
            .btn-copy { background: #fff3e0; color: #f57c00; }
            .btn-delete { background: #ffebee; color: #d32f2f; }

            /* Modal - Fixed for Mobile */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 2000;
                align-items: flex-end;
                justify-content: center;
                padding: 0;
                padding-bottom: var(--safe-area-inset-bottom);
                animation: fadeIn 0.3s ease;
            }

            .modal-content {
                background: white;
                border-radius: var(--radius) var(--radius) 0 0;
                padding: 24px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                animation: slideUp 0.3s ease;
                position: relative;
                margin-top: auto;
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            .modal-title {
                font-size: 20px;
                font-weight: 600;
            }

            .modal-close {
                background: none;
                border: none;
                font-size: 28px;
                cursor: pointer;
                color: #666;
                width: 44px;
                height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                touch-action: manipulation;
            }

            .modal-close:active {
                background: rgba(0,0,0,0.1);
            }

            /* Toast - Fixed Positioning */
            .toast {
                position: fixed;
                bottom: 20px;
                left: 16px;
                right: 16px;
                transform: translateY(100px);
                background: var(--primary);
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 2001;
                transition: transform 0.3s ease;
                text-align: center;
                font-size: 15px;
                max-width: calc(100% - 32px);
                margin: 0 auto;
            }

            .toast.show {
                transform: translateY(0);
            }

            .toast.success { background: var(--success); }
            .toast.error { background: var(--danger); }
            .toast.warning { background: var(--warning); color: #212529; }

            /* Loading */
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255,255,255,0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s ease-in-out infinite;
            }

            /* Empty State */
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #666;
            }

            .empty-state svg {
                width: 64px;
                height: 64px;
                margin-bottom: 20px;
                color: #ddd;
            }

            /* Scrollbar Styling */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            ::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

            /* Animations */
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            @keyframes slideUp {
                from { 
                    opacity: 0;
                    transform: translateY(100%);
                }
                to { 
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Responsive Improvements */
            @media (max-width: 374px) {
                body {
                    font-size: 15px;
                    padding-top: calc(75px + 52px + var(--safe-area-inset-top));
                }
                
                .header {
                    height: 75px;
                    padding: 12px;
                    padding-top: calc(12px + var(--safe-area-inset-top));
                }
                
                .header h1 {
                    font-size: 20px;
                }
                
                .tabs {
                    top: 75px;
                    height: 52px;
                }
                
                .tab {
                    padding: 16px 8px;
                    font-size: 15px;
                    min-height: 52px;
                }
                
                .btn, .action-btn {
                    padding: 16px 12px;
                    min-height: 52px;
                }
                
                .profile-actions {
                    gap: 6px;
                }
                
                .action-btn {
                    min-width: 65px;
                    font-size: 13px;
                }
            }

            @media (min-width: 768px) {
                body {
                    padding-top: calc(81px + 56px);
                    padding-bottom: 40px;
                }
                
                .modal {
                    align-items: center;
                    padding: 20px;
                }
                
                .modal-content {
                    border-radius: var(--radius);
                    max-width: 400px;
                    margin: 0;
                }
                
                .content {
                    padding: 24px;
                    max-width: 1200px;
                    margin: 0 auto;
                }
                
                .profiles-grid {
                    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                }
                
                .toast {
                    left: 50%;
                    right: auto;
                    transform: translateX(-50%) translateY(100px);
                    max-width: 400px;
                }
                
                .toast.show {
                    transform: translateX(-50%) translateY(0);
                }
            }

            @media (min-width: 1024px) {
                .profile-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                }
                
                .btn:hover {
                    transform: translateY(-1px);
                }
                
                .action-btn:hover {
                    transform: translateY(-1px);
                }
            }

            /* Fix for iOS input zoom */
            @media screen and (max-width: 768px) {
                input[type="date"],
                input[type="text"],
                input[type="email"],
                input[type="tel"],
                input[type="number"] {
                    font-size: 16px !important; /* Prevents iOS zoom */
                }
            }

            /* Hide arrows from number input */
            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            /* Photo Upload Options */
            .upload-options {
                display: flex;
                gap: 12px;
                margin-top: 15px;
                flex-wrap: wrap;
            }

            .upload-option-btn {
                flex: 1;
                padding: 14px;
                border: 2px solid var(--border);
                border-radius: 8px;
                background: white;
                color: var(--primary);
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.3s;
                min-height: 50px;
                min-width: 120px;
            }

            .upload-option-btn:hover, .upload-option-btn:active {
                border-color: var(--primary);
                background: rgba(0,0,0,0.02);
            }

            .upload-option-btn svg {
                width: 20px;
                height: 20px;
            }
        </style>
    </head>
    <body>
        <!-- Fixed Header -->
        <div class="header">
            <h1>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                KK Book Diary
            </h1>
        </div>

        <!-- Fixed Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showSection('profiles')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                Profiles
            </button>
            <button class="tab" onclick="showSection('create')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Create
            </button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Profiles Section -->
            <div id="profiles-section" class="section active">
                <div class="form-card">
                    <h2 style="margin-bottom: 16px; font-size: 20px;">All Profiles</h2>
                    <div id="profiles-list" class="profiles-grid">
                        <!-- Profiles will load here -->
                    </div>
                </div>
            </div>

            <!-- Create/Edit Section -->
            <div id="create-section" class="section">
                <div class="form-card">
                    <h2 style="margin-bottom: 20px; font-size: 20px;" id="form-title">Create New Profile</h2>
                    
                    <form id="profile-form">
                        <input type="hidden" id="profile-id">
                        
                        <div class="form-group">
                            <label for="name" class="required">Full Name</label>
                            <input type="text" id="name" required maxlength="100" placeholder="Enter full name" autocomplete="name">
                        </div>

                        <div class="form-group">
                            <label for="address" class="required">Address</label>
                            <input type="text" id="address" required maxlength="200" placeholder="Enter complete address" autocomplete="street-address">
                        </div>

                        <div class="form-group">
                            <label for="contact">Contact Info</label>
                            <input type="tel" id="contact" maxlength="100" placeholder="Phone or email (optional)" autocomplete="tel">
                        </div>

                        <div class="form-group">
                            <label for="date" class="required">Date</label>
                            <input type="date" id="date" required>
                        </div>

                        <div class="form-group">
                            <label for="note" class="required">Note</label>
                            <textarea id="note" required maxlength="500" placeholder="Write a short note about this person..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="required">Profile Photo</label>
                            <div class="photo-upload" onclick="showUploadOptions()" role="button" tabindex="0" onkeypress="if(event.key==='Enter') showUploadOptions()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                                <div>Click to choose photo</div>
                                <small style="color: #666; margin-top: 4px;">JPG, PNG (Max 5MB)</small>
                            </div>
                            
                            <!-- Hidden file inputs for different sources -->
                            <input type="file" id="photo-gallery" accept="image/*" onchange="handleFileSelect(event)" style="display: none;">
                            <input type="file" id="photo-camera" accept="image/*" capture="environment" onchange="handleFileSelect(event)" style="display: none;">
                            
                            <div id="photo-preview" class="photo-preview"></div>
                            
                            <!-- Upload Options Modal -->
                            <div id="upload-options-modal" class="modal">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <div class="modal-title">Choose Photo Source</div>
                                        <button class="modal-close" onclick="closeUploadOptions()" aria-label="Close">×</button>
                                    </div>
                                    <div style="margin-bottom: 20px;">
                                        <p style="margin-bottom: 16px; color: #666;">Select where you want to get the photo from:</p>
                                        <div class="upload-options">
                                            <button type="button" class="upload-option-btn" onclick="chooseFromGallery()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                                    <polyline points="21 15 16 10 5 21"/>
                                                </svg>
                                                Gallery
                                            </button>
                                            <button type="button" class="upload-option-btn" onclick="takePhoto()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                                    <circle cx="12" cy="13" r="4"/>
                                                </svg>
                                                Camera
                                            </button>
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <button class="btn btn-secondary" onclick="closeUploadOptions()" style="width: 100%;">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="buttons">
                            <button type="button" id="cancel-btn" class="btn btn-secondary" onclick="resetForm()" style="display: none;">
                                Cancel
                            </button>
                            <button type="submit" id="submit-btn" class="btn btn-primary">
                                <span id="submit-text">Create Profile</span>
                                <span id="submit-loading" class="loading" style="display: none;"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Modal -->
        <div id="delete-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Delete Profile</div>
                    <button class="modal-close" onclick="closeModal()" aria-label="Close">×</button>
                </div>
                <p style="margin-bottom: 24px;">Are you sure you want to delete this profile? This action cannot be undone.</p>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDelete()" style="flex: 1;">Delete</button>
                </div>
            </div>
        </div>

        <!-- Link Modal -->
        <div id="link-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Share Profile Link</div>
                    <button class="modal-close" onclick="closeModal()" aria-label="Close">×</button>
                </div>
                <p style="margin-bottom: 12px;">Copy this link to share the profile:</p>
                <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 20px; word-break: break-all; font-size: 14px;"
                    id="share-link"></div>
                <button class="btn btn-primary" onclick="copyLink()" style="width: 100%;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Copy Link
                </button>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="toast"></div>

    <script>
        // State
        let currentProfileId = null;
        let profiles = [];
        let isEditing = false;
        let deleteTargetId = null;
        let shareLink = '';
        let currentPhotoFile = null;

        // DOM Elements
        const API_BASE = '/api';
        const profilesList = document.getElementById('profiles-list');
        const profileForm = document.getElementById('profile-form');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitLoading = document.getElementById('submit-loading');
        const cancelBtn = document.getElementById('cancel-btn');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Prevent double-tap zoom on buttons
            const buttons = document.querySelectorAll('button, .photo-upload');
            buttons.forEach(btn => {
                btn.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });
            });

            loadProfiles();
            setupForm();
            setupDateInput();
        });

        // Setup date input
        function setupDateInput() {
            const dateInput = document.getElementById('date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            dateInput.max = today; // Cannot select future dates
        }

        // Tabs
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`${section}-section`).classList.add('active');
            document.querySelector(`.tab[onclick="showSection('${section}')"]`).classList.add('active');
            
            if (section === 'profiles') {
                loadProfiles();
            } else if (section === 'create') {
                // Scroll to top when switching to create
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Load Profiles
        async function loadProfiles() {
            try {
                showLoading();
                const response = await fetch(`${API_BASE}/profiles`);
                if (!response.ok) throw new Error('Failed to load');
                
                profiles = await response.json();
                renderProfiles();
            } catch (error) {
                showToast('Error loading profiles', 'error');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        function renderProfiles() {
            if (profiles.length === 0) {
                profilesList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <h3 style="margin-bottom: 8px;">No Profiles Yet</h3>
                        <p style="color: #666;">Create your first profile to get started</p>
                        <button class="btn btn-primary" onclick="showSection('create')" style="margin-top: 20px; max-width: 200px; margin-left: auto; margin-right: auto;">
                            Create Profile
                        </button>
                    </div>
                `;
                return;
            }

            profilesList.innerHTML = profiles.map(profile => `
                <div class="profile-card" data-id="${profile.id}">
                    <div class="profile-header">
                        <img src="${profile.photo}" alt="${profile.name}" class="profile-avatar"
                            onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIzMCIgY3k9IjMwIiByPSIzMCIgZmlsbD0iI2Y4ZjlmYSIvPjxwYXRoIGQ9Ik0zMCAzNUMzNS41MjI4IDM1IDQwIDMwLjUyMjggNDAgMjVDNDAgMTkuNDc3MiAzNS41MjI4IDE1IDMwIDE1QzI0LjQ3NzIgMTUgMjAgMTkuNDc3MiAyMCAyNUMyMCAzMC41MjI4IDI0LjQ3NzIgMzUgMzAgMzVaIiBmaWxsPSIjZTBlMGUwIi8+PHBhdGggZD0iTTAgNTBDMy41NzcxNS0yLjA2MzY3ZS0wNyAxMy4yODE0IDAgMjAgMEMyNi43MTg2IDAgMzMgMy41NzcxNSAzMyA4QzMzIDEyLjQyMjkgMjYuNzE4NiAxNiAyMCAxNkMxMy4yODE0IDE2IDcgMTIuNDIyOSA3IDhDNyAzLjU3NzE1IDEzLjI4MTQgMCAyMCAwQzI2LjcxODYgMCAzMyAzLjU3NzE1IDMzIDhDMzMgMTIuNDIyOSAyNi43MTg2IDE2IDIwIDE2QzEzLjI4MTQgMTYgNyAxMi40MjI5IDcgOFoiIGZpbGw9IiNkZGRkZGQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEzIDM0KSIvPjwvc3ZnPg=='">
                        <div class="profile-info">
                            <div class="profile-name">${escapeHtml(profile.name)}</div>
                            <div class="profile-date">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                ${formatDate(profile.date)}
                            </div>
                        </div>
                    </div>
                    <div class="profile-note">${escapeHtml(profile.note)}</div>
                    <div class="profile-actions">
                        <button class="action-btn btn-view" onclick="viewProfile('${profile.id}')" aria-label="View profile">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            View
                        </button>
                        <button class="action-btn btn-edit" onclick="editProfile('${profile.id}')" aria-label="Edit profile">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Edit
                        </button>
                        <button class="action-btn btn-copy" onclick="showLink('${profile.id}')" aria-label="Copy share link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            Share
                        </button>
                        <button class="action-btn btn-delete" onclick="showDeleteModal('${profile.id}')" aria-label="Delete profile">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Photo Upload Functions
        function showUploadOptions() {
            const modal = document.getElementById('upload-options-modal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeUploadOptions() {
            const modal = document.getElementById('upload-options-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function chooseFromGallery() {
            // First close the options modal
            closeUploadOptions();
            
            // Trigger the gallery file input
            const galleryInput = document.getElementById('photo-gallery');
            
            // Remove capture attribute to ensure gallery opens
            galleryInput.removeAttribute('capture');
            
            // For iOS Safari, we need to delay the click
            setTimeout(() => {
                galleryInput.click();
            }, 100);
        }

        function takePhoto() {
            // First close the options modal
            closeUploadOptions();
            
            // Trigger the camera file input
            const cameraInput = document.getElementById('photo-camera');
            
            // Set capture attribute for camera
            cameraInput.setAttribute('capture', 'environment');
            
            // For iOS Safari, we need to delay the click
            setTimeout(() => {
                cameraInput.click();
            }, 100);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                // User cancelled the selection
                return;
            }

            // Reset the input value so the same file can be selected again
            event.target.value = '';

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showToast('File size must be less than 5MB', 'error');
                return;
            }

            // Validate file type
            if (!file.type.match('image/jpeg') && !file.type.match('image/jpg') && !file.type.match('image/png')) {
                showToast('Only JPG and PNG images are allowed', 'error');
                return;
            }

            // Store the file for form submission
            currentPhotoFile = file;

            // Preview the image
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photo-preview').innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div style="margin-top: 8px;">
                        <button type="button" class="action-btn btn-danger" onclick="removePhoto()" style="max-width: 150px; margin: 0 auto;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                            Remove Photo
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            document.getElementById('photo-preview').innerHTML = '';
            currentPhotoFile = null;
            // Clear both file inputs
            document.getElementById('photo-gallery').value = '';
            document.getElementById('photo-camera').value = '';
        }

        // Form Handling
        function setupForm() {
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveProfile();
            });

            // Prevent form submission on Enter key in textarea
            document.getElementById('note').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    profileForm.requestSubmit();
                }
            });
        }

        async function saveProfile() {
            // Validate
            const name = document.getElementById('name').value.trim();
            const address = document.getElementById('address').value.trim();
            const date = document.getElementById('date').value;
            const note = document.getElementById('note').value.trim();
            
            if (!name || !address || !date || !note) {
                showToast('Please fill all required fields', 'error');
                return;
            }

            if (!isEditing && !currentPhotoFile) {
                showToast('Please upload a profile photo', 'error');
                return;
            }

            try {
                showLoading();
                
                const formData = new FormData();
                formData.append('name', name);
                formData.append('address', address);
                formData.append('contact', document.getElementById('contact').value.trim());
                formData.append('date', date);
                formData.append('note', note);
                
                if (currentPhotoFile) {
                    formData.append('photo', currentPhotoFile);
                }

                let endpoint, method;
                if (isEditing) {
                    endpoint = `${API_BASE}/profiles/${currentProfileId}`;
                    method = 'PUT';
                } else {
                    endpoint = `${API_BASE}/profiles`;
                    method = 'POST';
                }

                console.log('Sending request to:', endpoint);
                console.log('Method:', method);
                console.log('Has photo?', !!currentPhotoFile);
                
                const response = await fetch(endpoint, {
                    method: method,
                    body: formData
                    // Note: Don't set Content-Type header for FormData, browser will set it automatically
                });

                console.log('Response status:', response.status);
                
                let result;
                try {
                    result = await response.json();
                    console.log('Response data:', result);
                } catch (jsonError) {
                    console.error('Failed to parse JSON response:', jsonError);
                    throw new Error('Server returned invalid response');
                }
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to save profile');
                }

                showToast(result.message || 'Profile saved successfully', 'success');
                resetForm();
                loadProfiles();
                showSection('profiles');

            } catch (error) {
                console.error('Save error details:', error);
                showToast(error.message || 'Failed to save profile. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Edit Profile
        async function editProfile(id) {
            try {
                showLoading();
                const response = await fetch(`${API_BASE}/profiles/${id}`);
                if (!response.ok) throw new Error('Failed to load');
                
                const profile = await response.json();
                
                // Fill form
                document.getElementById('profile-id').value = profile.id;
                document.getElementById('name').value = profile.name;
                document.getElementById('address').value = profile.address;
                document.getElementById('contact').value = profile.contact || '';
                document.getElementById('date').value = profile.date;
                document.getElementById('note').value = profile.note;
                
                // Clear current photo file
                currentPhotoFile = null;
                
                // Show photo preview
                if (profile.photoUrl) {
                    document.getElementById('photo-preview').innerHTML = `
                        <img src="${profile.photoUrl}" alt="Current photo">
                        <div style="margin-top: 8px;">
                            <button type="button" class="action-btn btn-warning" onclick="removePhoto()" style="max-width: 200px; margin: 0 auto;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                                Change Photo
                            </button>
                        </div>
                        <div style="margin-top: 8px; font-size: 14px; color: #666;">Current photo (upload new to replace)</div>
                    `;
                }
                
                // Update UI for edit mode
                isEditing = true;
                currentProfileId = id;
                formTitle.textContent = 'Edit Profile';
                submitText.textContent = 'Update Profile';
                cancelBtn.style.display = 'flex';
                
                // Switch to create tab
                showSection('create');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                showToast('Error loading profile', 'error');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        // View Profile
        function viewProfile(id) {
            window.open(`/profile.html?id=${id}`, '_blank');
        }

        // Reset Form
        function resetForm() {
            profileForm.reset();
            document.getElementById('photo-preview').innerHTML = '';
            currentPhotoFile = null;
            // Clear file inputs
            document.getElementById('photo-gallery').value = '';
            document.getElementById('photo-camera').value = '';
            setupDateInput();
            
            isEditing = false;
            currentProfileId = null;
            formTitle.textContent = 'Create New Profile';
            submitText.textContent = 'Create Profile';
            cancelBtn.style.display = 'none';
            
            // Close upload options modal if open
            closeUploadOptions();
        }

        // Delete Profile
        function showDeleteModal(id) {
            deleteTargetId = id;
            document.getElementById('delete-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        async function confirmDelete() {
            try {
                showLoading();
                const response = await fetch(`${API_BASE}/profiles/${deleteTargetId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete');
                
                showToast('Profile deleted successfully', 'success');
                closeModal();
                loadProfiles();
                
            } catch (error) {
                showToast('Error deleting profile', 'error');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        // Share Link
        function showLink(id) {
            shareLink = `${window.location.origin}/profile.html?id=${id}`;
            document.getElementById('share-link').textContent = shareLink;
            document.getElementById('link-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        async function copyLink() {
            try {
                await navigator.clipboard.writeText(shareLink);
                showToast('Link copied to clipboard!', 'success');
                closeModal();
            } catch (error) {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = shareLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Link copied to clipboard!', 'success');
                closeModal();
            }
        }

        // Modal
        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => {
                m.style.display = 'none';
                m.classList.remove('show');
            });
            deleteTargetId = null;
            shareLink = '';
            document.body.style.overflow = 'auto';
        }

        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        });

        // Toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Loading
        function showLoading() {
            submitLoading.style.display = 'inline-block';
            submitText.style.display = 'none';
            submitBtn.disabled = true;
        }

        function hideLoading() {
            submitLoading.style.display = 'none';
            submitText.style.display = 'inline';
            submitBtn.disabled = false;
        }

        // Helpers
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeUploadOptions();
            }
        });

        // Handle back button on mobile
        window.addEventListener('popstate', () => {
            if (isEditing) {
                resetForm();
                showSection('profiles');
            }
        });
    </script>
    </body>
    </html>